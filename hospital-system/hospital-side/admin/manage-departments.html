<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>科室管理 - 医疗管理系统</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <style>
        /* 科室管理页面特定样式 */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .page-header h1 {
            color: #333;
        }
        
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-container input {
            flex: 1;
            max-width: 300px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .department-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .department-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .department-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .department-card h3 {
            margin-top: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .department-card p {
            margin-bottom: 10px;
            color: #666;
        }
        
        .department-card .doctor-count {
            color: #1a73e8;
            font-weight: 500;
        }
        
        .department-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            margin: 0;
        }
        
        .modal-header .close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .modal-header .close:hover {
            background-color: #f8f9fa;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* 列表视图样式 */
        .view-toggle {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }
        
        .view-toggle button {
            padding: 8px 15px;
            background-color: white;
            border: 1px solid #ddd;
            cursor: pointer;
        }
        
        .view-toggle button:first-child {
            border-radius: 4px 0 0 4px;
        }
        
        .view-toggle button:last-child {
            border-radius: 0 4px 4px 0;
        }
        
        .view-toggle button.active {
            background-color: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }
        
        .department-table {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .department-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .department-table th,
        .department-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .department-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .department-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-top: 20px;
        }
        
        .pagination button {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background-color: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .pagination button.active {
            background-color: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }
        
        .pagination button:disabled {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }
        
        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }
            
            .page-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .search-container input {
                max-width: 100%;
            }
            
            .department-list {
                grid-template-columns: 1fr;
            }
            
            /* 表格响应式处理 */
            .department-table {
                overflow-x: auto;
            }
            
            .department-table table {
                min-width: 600px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- 侧边栏导航 -->
        <aside class="sidebar">
            <h3>管理员菜单</h3>
            <ul>
                <li><a href="dashboard.html">仪表盘</a></li>
                <li><a href="manage-users.html">用户管理</a></li>
                <li><a href="manage-departments.html" class="active">科室管理</a></li>
                <li><a href="system-settings.html">系统设置</a></li>
                <li><a href="../login.html" id="logoutBtn">退出登录</a></li>
            </ul>
        </aside>
        
        <!-- 主内容区域 -->
        <main class="main-content">
            <div class="page-header">
                <h1>科室管理</h1>
                <button id="addDepartmentBtn" class="btn btn-primary">添加科室</button>
            </div>
            
            <!-- 视图切换 -->
            <div class="view-toggle">
                <button id="cardViewBtn" class="active">卡片视图</button>
                <button id="listViewBtn">列表视图</button>
            </div>
            
            <!-- 搜索 -->
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="搜索科室...">
            </div>
            
            <!-- 科室列表（卡片视图） -->
            <div id="departmentCards" class="department-list">
                <!-- 科室数据将通过JavaScript动态生成 -->
            </div>
            
            <!-- 科室列表（表格视图） -->
            <div id="departmentTable" class="department-table" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>科室名称</th>
                            <th>科室描述</th>
                            <th>医生数量</th>
                            <th>创建日期</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="departmentsTableBody">
                        <!-- 科室数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
            
            <!-- 分页 -->
            <div class="pagination">
                <button id="prevPage" disabled>上一页</button>
                <button class="active">1</button>
                <button>2</button>
                <button>3</button>
                <button id="nextPage">下一页</button>
            </div>
        </main>
    </div>
    
    <!-- 添加/编辑科室模态框 -->
    <div id="departmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">添加科室</h2>
                <button id="closeModal" class="close">&times;</button>
            </div>
            
            <form id="departmentForm">
                <input type="hidden" id="departmentId">
                
                <div class="form-group">
                    <label for="departmentName">科室名称 *</label>
                    <input type="text" id="departmentName" name="departmentName" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="departmentDesc">科室描述</label>
                    <textarea id="departmentDesc" name="departmentDesc" class="form-control" rows="4"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="departmentStatus">状态 *</label>
                    <select id="departmentStatus" name="departmentStatus" class="form-control" required>
                        <option value="active">启用</option>
                        <option value="inactive">禁用</option>
                    </select>
                </div>
                
                <div class="modal-footer">
                    <button type="button" id="cancelBtn" class="btn btn-secondary">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { validateForm, showAlert, storage } from '../../assets/js/utils.js';

        // 模拟科室数据
        const departmentsData = [
            { id: 1, name: '内科', description: '专注于成人疾病的诊断和治疗', doctorCount: 15, createDate: '2023-01-15', status: 'active' },
            { id: 2, name: '外科', description: '负责需要手术治疗的疾病', doctorCount: 12, createDate: '2023-01-15', status: 'active' },
            { id: 3, name: '儿科', description: '专注于儿童疾病的诊断和治疗', doctorCount: 8, createDate: '2023-01-15', status: 'active' },
            { id: 4, name: '妇科', description: '专注于女性生殖系统疾病的诊断和治疗', doctorCount: 6, createDate: '2023-01-15', status: 'active' },
            { id: 5, name: '眼科', description: '专注于眼部疾病的诊断和治疗', doctorCount: 4, createDate: '2023-02-10', status: 'active' },
            { id: 6, name: '皮肤科', description: '专注于皮肤疾病的诊断和治疗', doctorCount: 3, createDate: '2023-02-10', status: 'active' },
            { id: 7, name: '耳鼻喉科', description: '专注于耳鼻喉疾病的诊断和治疗', doctorCount: 5, createDate: '2023-03-05', status: 'active' },
            { id: 8, name: '神经内科', description: '专注于神经系统疾病的诊断和治疗', doctorCount: 7, createDate: '2023-03-05', status: 'active' },
            { id: 9, name: '心内科', description: '专注于心脏和血管疾病的诊断和治疗', doctorCount: 9, createDate: '2023-04-20', status: 'active' },
            { id: 10, name: '康复科', description: '专注于患者术后和疾病后的康复治疗', doctorCount: 3, createDate: '2023-05-15', status: 'inactive' },
        ];

        // 当前视图模式
        let currentView = 'card';

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 验证用户登录状态
            const userInfo = storage.get('userInfo');
            if (!userInfo || userInfo.userType !== 'admin') {
                window.location.href = '../login.html';
                return;
            }

            // 渲染科室列表
            renderDepartments();

            // 事件监听器
            setupEventListeners();
        });

        // 设置事件监听器
        function setupEventListeners() {
            // 添加科室按钮
            document.getElementById('addDepartmentBtn').addEventListener('click', function() {
                openModal('添加科室');
                // 重置表单
                document.getElementById('departmentForm').reset();
                document.getElementById('departmentId').value = '';
            });

            // 关闭模态框
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('cancelBtn').addEventListener('click', closeModal);

            // 表单提交
            document.getElementById('departmentForm').addEventListener('submit', function(e) {
                e.preventDefault();

                // 表单验证
                if (!validateForm('departmentForm')) {
                    return;
                }

                // 获取表单数据
                const departmentId = document.getElementById('departmentId').value;
                const formData = {
                    name: document.getElementById('departmentName').value,
                    description: document.getElementById('departmentDesc').value,
                    status: document.getElementById('departmentStatus').value
                };

                // 模拟提交到服务器
                console.log('保存科室信息:', formData);

                // 模拟成功保存
                showAlert('success', departmentId ? '科室信息更新成功' : '科室添加成功');

                // 关闭模态框
                closeModal();

                // 重新渲染列表
                if (departmentId) {
                    // 更新现有科室
                    const index = departmentsData.findIndex(dept => dept.id == departmentId);
                    if (index !== -1) {
                        departmentsData[index] = {
                            ...departmentsData[index],
                            name: formData.name,
                            description: formData.description,
                            status: formData.status
                        };
                    }
                } else {
                    // 添加新科室
                    const newDeptId = Math.max(...departmentsData.map(dept => dept.id)) + 1;
                    departmentsData.push({
                        id: newDeptId,
                        name: formData.name,
                        description: formData.description,
                        doctorCount: 0,
                        createDate: new Date().toISOString().split('T')[0],
                        status: formData.status
                    });
                }

                // 重新渲染列表
                renderDepartments();
            });

            // 搜索功能
            document.getElementById('searchInput').addEventListener('input', function() {
                renderDepartments();
            });

            // 视图切换
            document.getElementById('cardViewBtn').addEventListener('click', function() {
                switchToCardView();
            });

            document.getElementById('listViewBtn').addEventListener('click', function() {
                switchToListView();
            });

            // 分页按钮
            document.getElementById('prevPage').addEventListener('click', function() {
                // 实际项目中应实现分页逻辑
                showAlert('info', '分页功能将在实际项目中实现');
            });

            document.getElementById('nextPage').addEventListener('click', function() {
                // 实际项目中应实现分页逻辑
                showAlert('info', '分页功能将在实际项目中实现');
            });

            // 退出登录
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                storage.remove('userInfo');
                showAlert('success', '退出成功！');
                setTimeout(() => {
                    window.location.href = '../login.html';
                }, 1000);
            });

            // 点击模态框外部关闭
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('departmentModal');
                if (event.target === modal) {
                    closeModal();
                }
            });
        }

        // 切换到卡片视图
        function switchToCardView() {
            currentView = 'card';
            document.getElementById('cardViewBtn').classList.add('active');
            document.getElementById('listViewBtn').classList.remove('active');
            document.getElementById('departmentCards').style.display = 'grid';
            document.getElementById('departmentTable').style.display = 'none';
            renderDepartments();
        }

        // 切换到列表视图
        function switchToListView() {
            currentView = 'list';
            document.getElementById('listViewBtn').classList.add('active');
            document.getElementById('cardViewBtn').classList.remove('active');
            document.getElementById('departmentTable').style.display = 'block';
            document.getElementById('departmentCards').style.display = 'none';
            renderDepartments();
        }

        // 渲染科室列表
        function renderDepartments() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            // 筛选科室
            const filteredDepartments = departmentsData.filter(dept => 
                dept.name.toLowerCase().includes(searchTerm) || 
                dept.description.toLowerCase().includes(searchTerm)
            );

            if (currentView === 'card') {
                renderCardView(filteredDepartments);
            } else {
                renderListView(filteredDepartments);
            }
        }

        // 渲染卡片视图
        function renderCardView(departments) {
            const container = document.getElementById('departmentCards');
            container.innerHTML = '';

            if (departments.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <p>没有找到匹配的科室</p>
                    </div>
                `;
                return;
            }

            departments.forEach(dept => {
                // 状态样式
                const statusStyle = dept.status === 'active' ? 'color: green;' : 'color: red;';
                const statusText = dept.status === 'active' ? '启用' : '禁用';

                const card = document.createElement('div');
                card.className = 'department-card';
                card.innerHTML = `
                    <h3>
                        ${dept.name}
                        <span style="${statusStyle}" class="status-badge">${statusText}</span>
                    </h3>
                    <p>${dept.description}</p>
                    <p><span class="doctor-count">医生数量: ${dept.doctorCount}</span></p>
                    <p>创建日期: ${dept.createDate}</p>
                    <div class="department-actions">
                        <button class="btn btn-primary btn-edit" data-id="${dept.id}">编辑</button>
                        <button class="btn btn-secondary btn-view" data-id="${dept.id}">查看</button>
                        ${dept.doctorCount === 0 ? 
                            `<button class="btn btn-danger btn-delete" data-id="${dept.id}">删除</button>` : 
                            `<button class="btn btn-danger btn-delete" data-id="${dept.id}" disabled>删除</button>`
                        }
                    </div>
                `;

                container.appendChild(card);
            });

            // 添加编辑、查看、删除按钮的事件监听器
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const deptId = this.getAttribute('data-id');
                    editDepartment(deptId);
                });
            });

            document.querySelectorAll('.btn-view').forEach(btn => {
                btn.addEventListener('click', function() {
                    const deptId = this.getAttribute('data-id');
                    viewDepartment(deptId);
                });
            });

            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.hasAttribute('disabled')) return;
                    const deptId = this.getAttribute('data-id');
                    deleteDepartment(deptId);
                });
            });
        }

        // 渲染列表视图
        function renderListView(departments) {
            const tableBody = document.getElementById('departmentsTableBody');
            tableBody.innerHTML = '';

            departments.forEach(dept => {
                // 状态样式
                const statusStyle = dept.status === 'active' ? 'color: green;' : 'color: red;';
                const statusText = dept.status === 'active' ? '启用' : '禁用';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dept.id}</td>
                    <td>${dept.name}</td>
                    <td>${dept.description}</td>
                    <td>${dept.doctorCount}</td>
                    <td>${dept.createDate}</td>
                    <td style="${statusStyle}">${statusText}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-edit" data-id="${dept.id}">编辑</button>
                            <button class="btn btn-secondary btn-view" data-id="${dept.id}">查看</button>
                            ${dept.doctorCount === 0 ? 
                                `<button class="btn btn-danger btn-delete" data-id="${dept.id}">删除</button>` : 
                                `<button class="btn btn-danger btn-delete" data-id="${dept.id}" disabled>删除</button>`
                            }
                        </div>
                    </td>
                `;

                tableBody.appendChild(row);
            });

            // 添加编辑、查看、删除按钮的事件监听器
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const deptId = this.getAttribute('data-id');
                    editDepartment(deptId);
                });
            });

            document.querySelectorAll('.btn-view').forEach(btn => {
                btn.addEventListener('click', function() {
                    const deptId = this.getAttribute('data-id');
                    viewDepartment(deptId);
                });
            });

            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.hasAttribute('disabled')) return;
                    const deptId = this.getAttribute('data-id');
                    deleteDepartment(deptId);
                });
            });
        }

        // 打开模态框
        function openModal(title) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('departmentModal').style.display = 'flex';
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('departmentModal').style.display = 'none';
        }

        // 编辑科室
        function editDepartment(id) {
            const department = departmentsData.find(dept => dept.id == id);
            if (department) {
                document.getElementById('departmentId').value = department.id;
                document.getElementById('departmentName').value = department.name;
                document.getElementById('departmentDesc').value = department.description;
                document.getElementById('departmentStatus').value = department.status;
                openModal('编辑科室');
            }
        }

        // 查看科室
        function viewDepartment(id) {
            const department = departmentsData.find(dept => dept.id == id);
            if (department) {
                // 状态显示文本
                const statusText = department.status === 'active' ? '启用' : '禁用';

                // 在实际项目中，这里可以打开一个查看详情的模态框
                // 这里简单显示一个提示
                showAlert('info', `科室详情：\nID: ${department.id}\n名称: ${department.name}\n描述: ${department.description}\n医生数量: ${department.doctorCount}\n创建日期: ${department.createDate}\n状态: ${statusText}`);
            }
        }

        // 删除科室
        function deleteDepartment(id) {
            const department = departmentsData.find(dept => dept.id == id);
            if (department && department.doctorCount === 0) {
                if (confirm(`确定要删除"${department.name}"科室吗？此操作无法撤销。`)) {
                    // 模拟删除操作
                    console.log('删除科室:', id);
                    
                    // 从模拟数据中移除科室
                    const index = departmentsData.findIndex(dept => dept.id == id);
                    if (index !== -1) {
                        departmentsData.splice(index, 1);
                        
                        // 重新渲染列表
                        renderDepartments();
                        
                        showAlert('success', '科室已成功删除');
                    }
                }
            } else {
                showAlert('error', '只有医生数量为0的科室才能被删除');
            }
        }
    </script>
</body>
</html>